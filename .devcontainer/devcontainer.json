// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/docker-existing-dockerfile
{
	"name": "Smart Library Dev",

	"containerEnv": {
		"OPENAI_API_KEY": "${localEnv:OPENAI_API_KEY}"
	},

	"overrideCommand": false,

	"features": {
		"ghcr.io/devcontainers/features/common-utils:2": {},
		"ghcr.io/devcontainers/features/git:1": {},
		"ghcr.io/devcontainers/features/github-cli:1": {}
	},

	"dockerComposeFile": [
		"../docker-compose.yml"
	],
	"service": "devcontainer",

	"workspaceFolder": "/workspace",

	"customizations": {
		"vscode": {
			"extensions": [
				"ms-python.python",
				"ms-python.vscode-pylance",
				"ms-toolsai.jupyter",
				"ms-vscode.vscode-pdf",
				"mhutchie.git-graph",
				"ms-azuretools.vscode-docker",
				"eamodio.gitlens",
				"esbenp.prettier-vscode",
				"github.copilot",
				"github.copilot-chat"
			],

			// ==========================================================
			// RUN HEAVY EXTENSIONS ON THE HOST (UI) — NOT IN CONTAINER
			// This is what prevents extension-host freezes in WSL.
			// ==========================================================
			"remote.extensionKind": {
				"ms-python.python": ["ui"],
				"ms-python.vscode-pylance": ["ui"],
				"github.copilot": ["ui"],
				"github.copilot-chat": ["ui"],
				"github.copilot-labs": ["ui"],
				"GitHub.copilot-nightly": ["ui"]
			},

			"settings": {
				"python.defaultInterpreterPath": "${workspaceFolder}/.venv/bin/python",

				// ----------------------------------------------------------
				// PYTHON stability improvements (stop repeated environment scans)
				// ----------------------------------------------------------
				"python.experiments.enabled": false,
				"python.interpreter.infoVisibility": "off",
				"python.terminal.activateEnvironment": false,
				"python.terminal.activateEnvInCurrentTerminal": false,

				// ----------------------------------------------------------
				// COPILOT FREEZE MITIGATION — MOST IMPORTANT
				// ----------------------------------------------------------

				// Disable inline suggestions (frequent freeze trigger)
				"editor.inlineSuggest.enabled": false,

				// Disable streaming of responses (major freeze fix)
				"copilot.chat.streamResponse": false,

				// Disable heavy chat history reconstruction
				"copilot.chat.chatHistory": false,

				// Disable Copilot chat refresh on focus
				"copilot.chat.refreshOnFocus": false,

				// Use iframe-based webviews → avoids renderer UI freezes
				"workbench.editor.webview.experimental.useIframes": true,

				// Prevent webview suspension on blur
				"workbench.editor.webview.suspendOnBlur": false,

				// Editor open/reveal behavior
				"workbench.editor.openSideBySideDirection": "right",
				"workbench.editor.revealIfOpen": true,

				// ----------------------------------------------------------
				// Reduce file watcher load inside WSL/devcontainer
				// ----------------------------------------------------------
				"files.watcherExclude": {
					"**/node_modules": true,
					"**/dist": true,
					"**/.git": true
				},

				// TypeScript light mode
				"typescript.tsserver.useSeparateSyntaxServer": true,

				// Reduce background extensions noise
				"telemetry.telemetryLevel": "off"
			}
		}
	},

	// Increase memory for VS Code's extension host
	"remoteEnv": {
		"VSCODE_NODE_FLAGS": "--max-old-space-size=4096"
	}
}
